# Документация по модульным тестам

Этот документ предоставляет обзор модульных тестов, реализованных для проекта **whales-identification**.

## Введение

Модульные тесты необходимы для обеспечения надежности и корректности кодовой базы. Они помогают обнаруживать ошибки на ранних стадиях и делают код более поддерживаемым. Этот проект включает модульные тесты для критических компонентов, сосредотачиваясь на наиболее важных функциях.

## Структура тестов

Тесты находятся в директории `tests` и охватывают следующие модули:

- `utils.py`
- `filter_processor.py`
- `model.py`

### Файлы тестов

- `test_utils.py`: Тестирует вспомогательные функции.
- `test_filter_processor.py`: Тестирует процесс фильтрации данных.
- `test_model.py`: Тестирует основные компоненты модели.

## Обзор тестов

### 1. Тесты вспомогательных функций (`test_utils.py`)

**Тестируемая функциональность:**

- Функция `set_seed`

Убедитесь, что установка seed приводит к воспроизводимым случайным числам в разных библиотеках.

**Логика теста:**

1. Установите определенный seed с помощью `set_seed(42)`.
2. Сгенерируйте случайные числа с помощью `torch`, `numpy` и стандартного модуля `random`.
3. Сбросьте seed на то же значение и снова сгенерируйте числа.
4. Убедитесь, что числа из обоих наборов равны, подтверждая воспроизводимость.

### 2. Тесты процессора фильтрации (`test_filter_processor.py`)

**Тестируемая функциональность:**

- Метод `FilterProcessor.filter_data`

Проверяет, что метод правильно фильтрует записи с недопустимыми метками из набора данных.

**Логика теста:**

1. Создайте фиктивный набор данных с допустимыми и недопустимыми метками.
2. Создайте экземпляр `FilterProcessor` со списком допустимых меток.
3. Примените метод `filter_data` к набору данных.
4. Убедитесь, что остались только записи с допустимыми метками.

### 3. Тесты компонентов модели (`test_model.py`)

**Тестируемые компоненты:**

- Класс `GeM`

    Тестирует форму выходных данных слоя обобщенного среднего пула.

- Класс `ArcMarginProduct`

    Проверяет форму выходных данных и функциональность слоя потерь ArcFace.

- Класс `HappyWhaleModel`

    Проверяет прямой проход и размеры выходных данных.

**Логика теста:**

- **Тест GeM:**
    1. Создайте случайный тензор, имитирующий карты признаков.
    2. Пропустите его через слой `GeM`.
    3. Убедитесь, что выходные данные имеют ожидаемые размеры.

- **Тест ArcMarginProduct:**
    1. Сгенерируйте случайные векторы признаков и метки.
    2. Пропустите их через слой `ArcMarginProduct`.
    3. Убедитесь, что выходной тензор имеет правильную форму.

- **Тест HappyWhaleModel:**
    1. Создайте экземпляр модели с примерными параметрами.
    2. Создайте синтетические данные изображений и метки.
    3. Выполните прямой проход.
    4. Убедитесь, что выходные логиты имеют правильную форму.

## Запуск тестов

### Предварительные требования

Убедитесь, что все зависимости проекта установлены. Используйте **poetry** для управления зависимостями.

```bash
# Установите зависимости с помощью poetry
poetry install
```

### Выполнение тестов

Запустите следующую команду из корневой директории проекта:

```bash
poetry run python -m unittest discover tests
```

Эта команда обнаруживает и запускает все тесты в директории `tests`.

## Непрерывная интеграция

Проект использует GitHub Actions для автоматического тестирования при каждом пуше и pull request в ветку `main`.

**Файл рабочего процесса:** `python-app.yml`

**Шаги рабочего процесса:**

1. **Клонирование кода:**

     ```yaml
     - uses: actions/checkout@v4
     ```

2. **Настройка окружения Python:**

     ```yaml
     - name: Set up Python
         uses: actions/setup-python@v4
         with:
             python-version: '3.10'
     ```

3. **Установка зависимостей:**

     ```yaml
     - name: Install dependencies
         run: |
             pip install poetry
             poetry install
     ```

4. **Запуск тестов:**

     ```yaml
     - name: Run tests
         run: |
             poetry run python -m unittest discover tests
     ```

## Заключение

Сосредоточив внимание на этих ключевых функциях, модульные тесты помогают убедиться, что критические части кодовой базы работают правильно. Это повышает надежность проекта и облегчает дальнейшую разработку и поддержку.